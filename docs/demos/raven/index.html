<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Reading demo: The Raven, by Edgar Allen Poe</title>
</head>

<body>
    
    <main>
        
        <div class="poem-info">
            <h1 class="title">The Raven</h1>
            <p class="author">By Edgar Allen Poe</p>
        </div>

        <p class="stanza">
            <span class="line">Once upon a midnight dreary, while I pondered, weak and weary,</span>
            <span class="line">Over many a quaint and curious volume of forgotten lore&mdash;</span>
            <span class="line">While I nodded, nearly napping, suddenly there came a tapping,</span>
            <span class="line">As of some one gently rapping, rapping at my chamber door.</span>
            <span class="line">"'Tis some visiter," I muttered, "tapping at my chamber door&mdash;</span>
            <span class="line">Only this and nothing more."</span>
        </p>
        <p class="stanza">
            <span class="line">Ah, distinctly I remember it was in the bleak December;</span>
            <span class="line">And each separate dying ember wrought its ghost upon the floor.</span>
            <span class="line">Eagerly I wished the morrow;&mdash;vainly I had sought to borrow</span>
            <span class="line">From my books surcease of sorrow&mdash;sorrow for the lost Lenore&mdash;</span>
            <span class="line">For the rare and radiant maiden whom the angels name Lenore&mdash;</span>
            <span class="line">Nameless here for evermore.</span>
        </p>
        <p class="stanza">
            <span class="line">And the silken, sad, uncertain rustling of each purple curtain</span>
            <span class="line">Thrilled me&mdash;filled me with fantastic terrors never felt before;</span>
            <span class="line">So that now, to still the beating of my heart, I stood repeating</span>
            <span class="line">"'Tis some visiter entreating entrance at my chamber door&mdash;</span>
            <span class="line">Some late visiter entreating entrance at my chamber door;&mdash;</span>
            <span class="line">This it is and nothing more."</span>
        </p>

        <p class="stanza">
            <span class="line">Presently my soul grew stronger; hesitating then no longer,</span>
            <span class="line">"Sir," said I, "or Madam, truly your forgiveness I implore;</span>
            <span class="line">But the fact is I was napping, and so gently you came rapping,</span>
            <span class="line">And so faintly you came tapping, tapping at my chamber door,</span>
            <span class="line">That I scarce was sure I heard you"&mdash;here I opened wide the door;&mdash;</span>
            <span class="line">Darkness there and nothing more.</span>
        </p>

        <p class="stanza">
            <span class="line">Deep into that darkness peering, long I stood there wondering, fearing,</span>
            <span class="line">Doubting, dreaming dreams no mortal ever dared to dream before;</span>
            <span class="line">But the silence was unbroken, and the stillness gave no token,</span>
            <span class="line">And the only word there spoken was the whispered word, "Lenore?"</span>
            <span class="line">This I whispered, and an echo murmured back the word, "Lenore!"&mdash;</span>
            <span class="line">Merely this and nothing more.</span>
        </p>

        <p class="stanza">
            <span class="line">Back into the chamber turning, all my soul within me burning,</span>
            <span class="line">Soon I heard again a tapping somewhat louder than before.</span>
            <span class="line">"Surely," said I, "surely that is something at my window lattice;</span>
            <span class="line">Let me see, then, what thereat is, and this mystery explore&mdash;</span>
            <span class="line">Let my heart be still a moment and this mystery explore;&mdash;</span>
            <span class="line">'Tis the wind and nothing more!"</span>
        </p>

        <p class="stanza">
            <span class="line">Open here I flung the shutter, when, with many a flirt and flutter,</span>
            <span class="line">In there stepped a stately Raven of the saintly days of yore;</span>
            <span class="line">Not the least obeisance made he; not a minute stopped or stayed he;</span>
            <span class="line">But, with mien of lord or lady, perched above my chamber door&mdash;</span>
            <span class="line">Perched upon a bust of Pallas just above my chamber door&mdash;</span>
            <span class="line">Perched, and sat, and nothing more.</span>
        </p>

        <p class="stanza">
            <span class="line">Then this ebony bird beguiling my sad fancy into smiling,</span>
            <span class="line">By the grave and stern decorum of the countenance it wore,</span>
            <span class="line">"Though thy crest be shorn and shaven, thou," I said, "art sure no craven,</span>
            <span class="line">Ghastly grim and ancient Raven wandering from the Nightly shore&mdash;</span>
            <span class="line">Tell me what thy lordly name is on the Night's Plutonian shore!"</span>
            <span class="line">Quoth the Raven "Nevermore."</span>
        </p>

        <p class="stanza">
            <span class="line">Much I marvelled this ungainly fowl to hear discourse so plainly,</span>
            <span class="line">Though its answer little meaning&mdash;little relevancy bore;</span>
            <span class="line">For we cannot help agreeing that no living human being</span>
            <span class="line">Ever yet was blessed with seeing bird above his chamber door&mdash;</span>
            <span class="line">Bird or beast upon the sculptured bust above his chamber door,</span>
            <span class="line">With such name as "Nevermore."</span>
        </p>

        <p class="stanza">
            <span class="line">But the Raven, sitting lonely on the placid bust, spoke only</span>
            <span class="line">That one word, as if his soul in that one word he did outpour.</span>
            <span class="line">Nothing farther then he uttered&mdash;not a feather then he fluttered&mdash;</span>
            <span class="line">Till I scarcely more than muttered "Other friends have flown before&mdash;</span>
            <span class="line">On the morrow he will leave me, as my Hopes have flown before."</span>
            <span class="line">Quoth the Raven "Nevermore."</span>
        </p>

        <p class="stanza">
            <span class="line">Wondering at the stillness broken by reply so aptly spoken,</span>
            <span class="line">"Doubtless," said I, "what it utters is its only stock and store</span>
            <span class="line">Caught from some unhappy master whom unmerciful Disaster</span>
            <span class="line">Followed fast and followed faster so, when Hope he would adjure,</span>
            <span class="line">Stern Despair returned, instead of the sweet Hope he dared adjure&mdash;</span>
            <span class="line">That sad answer, "Nevermore!"</span>
        </p>

        <p class="stanza">
            <span class="line">But the Raven still beguiling my sad soul into smiling,</span>
            <span class="line">Straight I wheeled a cushioned seat in front of bird, and bust and door;</span>
            <span class="line">Then, upon the velvet sinking, I betook myself to linking</span>
            <span class="line">Fancy unto fancy, thinking what this ominous bird of yore&mdash;</span>
            <span class="line">What this grim, ungainly, ghastly, gaunt, and ominous bird of yore</span>
            <span class="line">Meant in croaking "Nevermore."</span>
        </p>

        <p class="stanza">
            <span class="line">This I sat engaged in guessing, but no syllable expressing</span>
            <span class="line">To the fowl whose fiery eyes now burned into my bosom's core;</span>
            <span class="line">This and more I sat divining, with my head at ease reclining</span>
            <span class="line">On the cushion's velvet lining that the lamp-light gloated o'er,</span>
            <span class="line">But whose velvet-violet lining with the lamp-light gloating o'er,</span>
            <span class="line">She shall press, ah, nevermore!</span>
        </p>

        <p class="stanza">
            <span class="line">Then, methought, the air grew denser, perfumed from an unseen censer</span>
            <span class="line">Swung by angels whose faint foot-falls tinkled on the tufted floor.</span>
            <span class="line">"Wretch," I cried, "thy God hath lent thee &mdash;by these angels he hath sent thee</span>
            <span class="line">Respite &mdash;respite and nepenthe, from thy memories of Lenore;</span>
            <span class="line">Oh let me quaff this kind nepenthe and forget this lost Lenore!"</span>
            <span class="line">Quoth the Raven "Nevermore."</span>
        </p>

        <p class="stanza">
            <span class="line">"Prophet!" said I, "thing of evil! &mdash;prophet still, if bird or devil!&mdash;</span>
            <span class="line">Whether Tempter sent, or whether tempest tossed thee here ashore,</span>
            <span class="line">Desolate yet all undaunted, on this desert land enchanted&mdash;</span>
            <span class="line">On this home by Horror haunted &mdash; tell me truly, I implore&mdash;</span>
            <span class="line">Is there &mdash;is there balm in Gilead? &mdash;tell me &mdash;tell me, I implore!"</span>
            <span class="line">Quoth the Raven "Nevermore."</span>
        </p>

        <p class="stanza">
            <span class="line">"Prophet!" said I, "thing of evil! &mdash;prophet still, if bird or devil!</span>
            <span class="line">By that Heaven that bends above us &mdash;by that God we both adore&mdash;</span>
            <span class="line">Tell this soul with sorrow laden if, within the distant Aidenn,</span>
            <span class="line">It shall clasp a sainted maiden whom the angels name Lenore&mdash;</span>
            <span class="line">Clasp a rare and radiant maiden whom the angels name Lenore."</span>
            <span class="line">Quoth the Raven "Nevermore."</span>
        </p>

        <p class="stanza">
            <span class="line">"Be that word our sign of parting, bird or fiend!" I shrieked, upstarting&mdash;</span>
            <span class="line">"Get thee back into the tempest and the Night's Plutonian shore!</span>
            <span class="line">Leave no black plume as a token of that lie thy soul hath spoken!</span>
            <span class="line">Leave my loneliness unbroken! &mdash;quit the bust above my door!</span>
            <span class="line">Take thy beak from out my heart, and take thy form from off my door!"</span>
            <span class="line">Quoth the Raven "Nevermore."</span>
        </p>

        <p class="stanza">
            <span class="line">And the Raven, never flitting, still is sitting, still is sitting</span>
            <span class="line">On the pallid bust of Pallas just above my chamber door;</span>
            <span class="line">And his eyes have all the seeming of a demon that is dreaming,</span>
            <span class="line">And the lamp-light o'er him streaming throws his shadow on the floor;</span>
            <span class="line">And my soul from out that shadow that lies floating on the floor</span>
            <span class="line">Shall be lifted &mdash;nevermore!</span>
        </p>
    </main>

    <aside>
        <details id="about">
            <summary><h2>About</h2></summary>
            <p>The text and audio sources for this page are in the public domain.</p>
            <p>Text by Edgar Allen Poe, published January 29, 1845.</p>
            <p><a href="https://en.wikipedia.org/wiki/File:Edgar_Allan_Poe_-_The_Raven.ogg">Audio by
                FergusRossFerrier</a>.
            Recording licensed under creative commons (<a
                href="https://creativecommons.org/licenses/by-sa/3.0/deed.en">CC-by-SA 3.0</a>).</p>
        </details>
    </aside>
    
    <aside aria-labelled-by="narration-title" id="narration">
        <h2 id="narration-title">Narration</h2>
        <audio id="narration-audio" src="raven.mp3" controls>
            <track id="text-sync" kind="metadata" src="raven.vtt" label="Highlighting" default/>
        </audio>
        <div id="narration-highlight">
            <h3>Highlights:</h3>
        </div>
    </aside>

    <script>
        let audio = document.querySelector('#narration-audio');
        let track = Array.from(audio.textTracks)[0];
        let didSetup = false;
        let highlightStack = {};
        // group names are in in highlight priority order
        // this would be nice to indicate delclaratively
        let groupNames = ['Stanza', 'Line', 'Word'];
        audio.onpause = e => {
            console.log("PAUSE");
        };
        audio.oncanplaythrough = e => {
            if (!didSetup) {
                let cues = Array.from(track.cues);
                cues.map(cue => {
                    cue.onenter = e => {
                        try {
                            let cueMeta = JSON.parse(cue.text);
                            let elmRange = createRange(cueMeta.selector)
                            let newHighlight = new Highlight(elmRange);
                            highlightStack[cueMeta.group] = newHighlight;
                            applyHighlights();
                            let node = elmRange.startContainer.nodeType == 1 ? elmRange.startContainer : elmRange.startContainer.parentNode;
                            if (!isInViewport(node)) {
                                node.scrollIntoView();
                            }
                        }
                        catch(err) {
                            console.log("ERROR ", cue.text);
                        }
                    };
                });
                let groups = Array.from(new Set(cues.map(cue => JSON.parse(cue.text)?.group ?? ""))).filter(group => group != "");
                document.querySelector('#narration-highlight').innerHTML += 
                    groups.map(group => 
                    `<div>
                        <label>${group}</label>
                        <input type="checkbox" checked 
                            id="highlight-option-${group}" />
                    </div>`)
                    .join('')

                
                let highlightOptions = Array.from(document.querySelectorAll('#narration-highlight input[type=checkbox]'));
                highlightOptions.map(inputCheckbox => {
                    inputCheckbox.onchange = e => {
                        let group = e.target.id.replace('highlight-option-', '');
                        // turn it off if it's on
                        if (!e.target.checked) {
                            if (CSS.highlights.has(group)) {
                                CSS.highlights.delete(group);
                            }
                        }
                        else {
                            applyHighlights();
                        }
                    };
                });
                didSetup = true;
            }
        };
        
        function applyHighlights() {
            // apply them in priority order
            for(let groupName of groupNames) {
                if (document.querySelector(`#highlight-option-${groupName}`).checked 
                    && highlightStack.hasOwnProperty(groupName)) {
                    CSS.highlights.set(groupName, highlightStack[groupName]);
                }
            }           
        }
        
        
        function isInViewport(elm) {
            let bounding = elm.getBoundingClientRect();
            let doc = elm.ownerDocument;
            return (
                bounding.top >= 0 &&
                bounding.left >= 0 &&
                bounding.bottom <= (doc.defaultView.innerHeight || doc.documentElement.clientHeight) &&
                bounding.right <= (doc.defaultView.innerWidth || doc.documentElement.clientWidth)
            );
        }
        // for CssSelector optionally with TextPositionSelector as its refinedBy
        function createRange(rangeSelector) {
            let node = document.querySelector(rangeSelector.value);
            let startOffset = 0;
            let endOffset = 0;
            if (rangeSelector.hasOwnProperty('refinedBy')) {
                startOffset = rangeSelector.refinedBy.start;
                endOffset = rangeSelector.refinedBy.end;
                
                return new StaticRange({
                    startContainer: node.firstChild,
                    startOffset,
                    endContainer: node.firstChild,
                    endOffset: endOffset + 1
                });
            }
            
            return new StaticRange({
                startContainer: node,
                startOffset: 0,
                endContainer: node.nextSibling,
                endOffset: 0
            });
        }
    </script>

    
</body>

</html>